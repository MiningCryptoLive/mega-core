mirror_db:
  image: postgres:12
  container_name: mirror_db
  environment:
    POSTGRES_DB: ${POSTGRES_DB}
    POSTGRES_USER: ${POSTGRES_USER}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    PGDATA: /var/lib/postgresql/data/pgdata
    PRIMARY_IP: ${PRIMARY_IP}
    PRIMARY_PORT: ${PRIMARY_PORT:-5432}
    REPLICATION_USER: ${REPLICATION_USER}
    REPLICATION_PASSWORD: ${REPLICATION_PASSWORD}
  volumes:
    - postgres_mirror_data:/var/lib/postgresql/data
    - ./conf/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    - ./conf/pg_hba.conf.template:/etc/postgresql/pg_hba.conf.template:ro
    - ./conf/pg_ident.conf:/etc/postgresql/pg_ident.conf:ro
    - ./conf/init_mirror_db.sh:/docker-entrypoint-initdb.d/init_mirror_db.sh
  ports:
    - "5434:5432"
  command: >
    bash -c "
      envsubst < /etc/postgresql/pg_hba.conf.template > /etc/postgresql/pg_hba.conf &&
      chmod 600 /etc/postgresql/pg_hba.conf &&
      docker-entrypoint.sh postgres -c config_file=/etc/postgresql/postgresql.conf
    "
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
    interval: 10s
    timeout: 5s
    retries: 5
  restart: unless-stopped